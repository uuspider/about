---
layout: post
title: sed basics
---
## sed 基础

参考：[sed, a stream editor][ref1]{:target="_blank"}

[ref1]:http://www.gnu.org/software/sed/manual/sed.html

<h2 id="top"></h2>

***

*   [文本替换](#s)
*   [sed 选项](#option)
*   [sed 动作](#cmd)
    *   [添加](#ai)
    *   [替换](#c)
    *   [删除](#d)
    *   [打印](#p)
*   [位置参数](#address)
*   [其它常用项](#cmdplus)
    *   [引用](#quote)
    *   [多项引用](#multiquote)
    *   [不执行](#notdo)
    *   [退出](#quit)
    *   [标记行号](#numline)
*   [缓存空间](#pattern)
*   [关于引号](#quotationmark)

***

和`grep`一样，`sed`也是按行处理文件；不同的是，`sed`命令具有编辑功能，是一种“流编辑器”(stream editor)，因此，除了使用[正则表达式](http://about.uuspider.com/2015/07/15/grep.html#basic)匹配目标字符，还需要明确编辑类型，并指定编辑位置，这些功能使得`sed`比`grep`命令的格式更复杂一些。

对文本的编辑动作，包括替换、插入、删除等，下面我们通过“替换”动作来了解`sed`命令的操作方法。

***

## `s`: 文本替换  {#s}

    $ sed 's/root/ROOT/' /etc/passwd

这条命令是将`/etc/passwd`中的“root”替换为“ROOT”，其中`s`是“替换”命令符，`/`是分隔符。

    $ sed '1,5s/root/ROOT/' /etc/passwd
    
这是将第2行到第5行中的“root”替换为“ROOT”。需要指出的是，`sed`默认只替换一行中的第一个匹配项，如果要替换该行所有匹配项，需要在命令后加上`g`：

    $ sed '1,5s/root/ROOT/g'  /etc/passwd
    
如果只替换一行的第二个匹配项，应该这样写：

    $ sed '1,5s/root/ROOT/2'  /etc/passwd
    
如果替换一行中第二个和以后的匹配项，应该这样写：

    $ sed '1,5s/root/ROOT/2g'  /etc/passwd
    
如果替换一行中第一个和第三个匹配项，可以这样写：

    $ sed '1,5s/root/ROOT/1;1,5s/root/ROOT/2'  /etc/passwd

也可以这样写：

    $ sed -e '1,5s/root/ROOT/1' -e '1,5s/root/ROOT/2'  /etc/passwd
    
这里我们使用了一个选项`-e`，表示允许表达式有多个执行动作，动作之间用";"分开。注意：第二个动作附加的是数字2而不是3！这表明多个动作是相继进行的，而不是同时进行的，因此，**动作的顺序会影响最终的输出结果**。
    
`sed`处理后文件后会全部输出到屏幕，这样不方便查看处理结果，有时候我们更需要`sed`只输出经过处理的行，这时应该使用选项`-n`。

上面几条命令中，`sed`仅将处理过的内容输出到屏幕，而不会影响文件本身，如果希望该结果覆盖原文件，应该使用选项`-i`。

***

## sed 选项 {#option}

    $ sed [选项] 表达式 [FILE...]

|选项:||
|:---|:---|
|`-e`:|允许表达式有多个动作，动作之间以";"分开|
|`-n`:|只显示经过`sed`处理过的行|
|`-i`:|将`sed`输出结果保存到原文件|
|`-r`:|使用扩展的正则表达式|

<br>
***

## sed 常用动作 {#cmd}

和上文的[替换](#s)动作相比，下面这些动作就比较容易理解了。

### `i`和`a`: 添加行 {#ai}

    $ sed '1 i This is my passwd file.'  /etc/passwd
    
`i`: insert，在匹配项所在行之前添加新行。

    $ sed '$ a This is my passwd file.'  /etc/passwd

`a`: append，在匹配项所在行之后添加新行。这里的`$`表示最后一行。

    $ sed '/false/a Attention!\Attention!\Attention!' /etc/passwd
    
在含有匹配字符“false'的行之后添加新行。

### `c`: 替换行 {#c}

    $ sed '/false/c Attention 3 plese!\
    Attention 2 plese!\
    Attention 1 plese!' /etc/passwd
    
替换多行时，每行末尾应添加`\`表示命令尚未结束，上面的`i`命令和`a`命令中也有类似的用法。

### `d`: 删除行 {#d}

    $ sed '/false/d' /etc/passwd

### `p`: 打印 {#p}

    $ sed -n '1,/false/p' /etc/passwd

表示从第一行开始打印到匹配"false"成功的那一行。ps：`p`命令常与`-n`选项配合使用。

    $ sed -n '/nobody/,/false/p' /etc/passwd
    
表示从匹配"nobody"成功的行开始打印，到匹配"false"成功的行时结束打印。

***

## 位置参数 {#address}

### 指定行

    $ sed '1 i This is my passwd file.'  /etc/passwd

### 指定行范围

    $ sed '1,5s/root/ROOT/' /etc/passwd

### 正则匹配行

    $ sed '/false/d' /etc/passwd
    $ sed '/root/s/root/ROOT/2'  /etc/passwd
        
可使用正则表达式指定匹配项所在的行。注意：末尾的数字2表示对该行第2个匹配项执行`s`动作。

### 正则匹配行范围 

    $ sed -n '/nobody/,/false/p' /etc/passwd

从含有"nobody"的行开始打印，到含有"false"的行时结束打印。

***

## 其它常用项 {#cmdplus}

### `&`: 引用 {#quote}

    $ sed 's/root/[&]/g' /etc/passwd
    
把"root"替换成"[root]"，`&`引用被匹配的字符串。

### `( )`: 多项引用 {#multiquote}

    $ sed -n 's/\(^.*\):x:.*no\(.*\)$/\1:never\2/g' /etc/passwd
    
`( )`配合使用`\1`，`\2`等可实现多个项目的引用。注意：`( )`需要使用转义符。

### `!`: 不执行 {#notdo}

    $ sed '1!s/root/[&]/g' /etc/passwd
    
不执行`!`后的动作。

### `q`: 退出 {#quit}

    $ sed '/false/q' /etc/passwd
    
发现含有"false"的行时，退出`sed`。

### `=`: 标记行号 {#numline}

    $ sed '=' /etc/passwd | sed 'N;s/\n/\t/'
    
给文件加上行号。这里用到了一个新动作的命令`N`，要理解其动作方法，需要了解`sed`命令中“Pattern Space”和“Hold Space”的概念。

***

## 缓存空间 {#pattern}

有时候我们需要合并两行文本，比如，把第1行和第2行合并成1行，而`sed`只能处理1行文本，怎么办？有必要引入一个能够暂存数据的区域，这个数据缓存区被称为Hold Space (缓存区)；相对的，正在处理数据的区域就被称为Pattern Space (主存区)了。

### `N`: 追加下一行到当前行，组成一个新行

    $ sed '=' /etc/passwd | sed 'N;s/\n/\t/'
    
在这条命令中，管道符左侧的命令为文本加上了行号，但是行号是自成一行，因此，我们使用`N`命令，首先将当前行的下一行存到缓存区，然后在主存区中把当前行的换行符`\n`替换为制表符`\t`，最后把缓存区中的内容追加到主存区之后。

引入缓存区使`sed`的功能得到极大的拓展，常用的相关动作命令有：

|:---|:---|
|`g`: |清空主存区，将缓存区中的内容复制到主存区|
|`G`: |将缓存区中的内容追加到主存区\n之后(新建一行)|
|`h`: |清空缓存区，将主存区中的内容复制到缓存区|
|`H`: |将主存区中的内容追加到缓存区\n之后|
|`x`: |交换主存区和缓存区的内容|

<br>
***

## 关于引号 {#quotationmark}

单引号是完全的引用，其中的内容不会做任何处理，完全保持原样输出给`sed`；双引号是部分的引用，其中的命令、变量会被解析、替换，再与其它内容一并输出给`sed`；不加引号时，如果字符串中含有空格，输出会不完整，因此最好还是根据需要选用单引号或双引号。

***